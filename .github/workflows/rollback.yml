name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to rollback to (SHA or timestamp)'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: louayelbiche/sales-agent-demo

jobs:
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Validate image exists
        run: |
          docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
          FULL_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}"
          echo "Checking: $FULL_IMAGE"
          docker manifest inspect "$FULL_IMAGE" > /dev/null 2>&1 || \
            (echo "ERROR: Image not found" && exit 1)

      - name: Rollback via SSH
        uses: appleboy/ssh-action@v1
        env:
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_USER: ${{ github.actor }}
          ROLLBACK_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: GHCR_TOKEN,GHCR_USER,ROLLBACK_IMAGE
          script: |
            set -e
            cd /opt/sales-agent-demo

            echo "Rolling back to: $ROLLBACK_IMAGE"
            echo "Reason: ${{ inputs.reason }}"

            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            docker pull "$ROLLBACK_IMAGE"

            cat > docker-compose.override.yml << EOF
            services:
              app:
                image: $ROLLBACK_IMAGE
            EOF

            docker compose -f docker-compose.prod.yml -f docker-compose.override.yml up -d

            for i in {1..15}; do
              curl -sf http://localhost:3005/api/health && break
              [ $i -eq 15 ] && exit 1
              sleep 5
            done

            echo "Rollback successful!"
